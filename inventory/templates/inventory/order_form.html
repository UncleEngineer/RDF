{% extends 'inventory/base.html' %}
{% block title %}Order Material{% endblock %}
{% block content %}
<h2>üõí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>

<!-- ‡πÅ‡∏™‡∏î‡∏á Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="mb-4">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</label>
      <input type="text" class="form-control" value="{{ request.user.username }}" disabled>
    </div>
    <div class="col-md-3">
      <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
      <input type="text" class="form-control" value="MOD-{{ order_id }}" disabled>
    </div>
    <div class="col-md-3">
      <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
      <input type="text" class="form-control" value="{{ today|date:'Y-m-d H:i' }}" disabled>
    </div>
    <div class="col-md-3">
      <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <input type="text" class="form-control bg-warning text-dark" value="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" disabled>
    </div>
  </div>
</div>

<form method="post">
  {% csrf_token %}
  
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="delivery_round" class="form-label">‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á <span class="text-danger">*</span></label>
      <select class="form-select" id="delivery_round" name="delivery_round" required>
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á --</option>
        {% for round in delivery_rounds %}
          <option value="{{ round.id }}">{{ round.name }}</option>
        {% endfor %}
      </select>
      <div class="form-text">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <a href="/admin/inventory/deliveryround/" target="_blank">Django Admin</a></div>
    </div>
    <div class="col-md-6">
      <label for="note" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea class="form-control" id="note" name="note" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
    </div>
  </div>

  <div class="mb-3">
    <input type="text" id="searchBox" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö...">
  </div>
  <ul id="search-results" class="list-group mb-4"></ul>

  <table class="table table-bordered" id="orderTable">
    <thead class="table-secondary">
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
        <th>‡∏£‡∏ß‡∏°</th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="text-end mb-3">
    <strong>‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="grandTotal" class="text-primary fs-5">0.00</span> ‡∏ö‡∏≤‡∏ó</strong>
  </div>
  
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-check"></i> ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    </button>
    <a href="{% url 'home' %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
    </a>
  </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const searchBox = document.getElementById('searchBox');
  const searchResults = document.getElementById('search-results');
  const orderTableBody = document.querySelector('#orderTable tbody');
  const grandTotalEl = document.getElementById('grandTotal');

  searchBox.addEventListener('input', function () {
    const query = this.value;
    if (query.length < 2) {
      searchResults.innerHTML = '';
      return;
    }
    
    fetch(`/search/?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        searchResults.innerHTML = '';
        if (data.length === 0) {
          searchResults.innerHTML = '<li class="list-group-item">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';
        } else {
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            li.style.cursor = 'pointer';
            li.innerHTML = `
              <span>${item.name} (${item.code})</span>
              <span class="badge bg-secondary">${item.cost} ‡∏ö‡∏≤‡∏ó</span>
            `;
            li.onclick = () => selectMaterial(item.id, item.name, item.cost);
            searchResults.appendChild(li);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        searchResults.innerHTML = '<li class="list-group-item text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</li>';
      });
  });

  function selectMaterial(id, name, cost) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const existingRow = document.querySelector(`input[name="material_id"][value="${id}"]`);
    if (existingRow) {
      alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
      searchBox.value = '';
      searchResults.innerHTML = '';
      return;
    }

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <input type="hidden" name="material_id" value="${id}">
        <strong>${name}</strong>
      </td>
      <td>
        <input type="hidden" name="cost" value="${cost}">
        <span class="fw-bold text-success">${cost}</span> ‡∏ö‡∏≤‡∏ó
      </td>
      <td>
        <input type="number" name="qty" value="1" min="1" class="form-control qty" oninput="updateTotal(this)" style="width: 100px;">
      </td>
      <td class="total fw-bold text-primary">${cost.toFixed(2)}</td>
      <td>
        <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
          üóëÔ∏è ‡∏•‡∏ö
        </button>
      </td>
    `;
    orderTableBody.appendChild(row);
    updateGrandTotal();
    searchBox.value = '';
    searchResults.innerHTML = '';
  }

  function updateTotal(input) {
    const row = input.closest('tr');
    const qty = parseFloat(input.value) || 0;
    const cost = parseFloat(row.querySelector('[name="cost"]').value);
    row.querySelector('.total').textContent = (qty * cost).toFixed(2);
    updateGrandTotal();
  }

  function removeRow(btn) {
    btn.closest('tr').remove();
    updateGrandTotal();
  }

  function updateGrandTotal() {
    let total = 0;
    document.querySelectorAll('#orderTable .total').forEach(td => {
      total += parseFloat(td.textContent);
    });
    grandTotalEl.textContent = total.toFixed(2);
  }

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit form ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  document.querySelector('form').addEventListener('submit', function(e) {
    const materialCount = document.querySelectorAll('input[name="material_id"]').length;
    if (materialCount === 0) {
      e.preventDefault();
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
      return;
    }
    
    const deliveryRound = document.getElementById('delivery_round').value;
    if (!deliveryRound) {
      e.preventDefault();
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
      return;
    }
  });
</script>
{% endblock %}