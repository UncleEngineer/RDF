{% extends 'inventory/base.html' %}
{% block title %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö MOD-{{ order.id|stringformat:"05d" }}</h2>
  <div>
    {% if order.approval_status == 'pending' %}
      <span class="badge bg-warning fs-6">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
    {% elif order.approval_status == 'approved' %}
      <span class="badge bg-success fs-6">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
    {% elif order.approval_status == 'rejected' %}
      <span class="badge bg-danger fs-6">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
    {% endif %}
  </div>
</div>

<!-- ‡πÅ‡∏™‡∏î‡∏á Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<!-- Order Information Card -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3">
        <strong>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå:</strong><br>
        <span class="badge bg-primary fs-6">MOD-{{ order.id|stringformat:"05d" }}</span>
      </div>
      <div class="col-md-3">
        <strong>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á:</strong><br>
        <span class="text-primary">{{ order.ordered_by.username }}</span>
      </div>
      <div class="col-md-3">
        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á:</strong><br>
        {{ order.created_at|date:"d/m/Y H:i" }}
      </div>
      <div class="col-md-3">
        <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong><br>
        {{ order.updated_at|date:"d/m/Y H:i" }}
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="col-md-4">
        <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong><br>
        {% if order.approval_status == 'pending' %}
          <span class="badge bg-warning">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
        {% elif order.approval_status == 'approved' %}
          <span class="badge bg-success">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
        {% elif order.approval_status == 'rejected' %}
          <span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
        {% endif %}
      </div>
      <div class="col-md-4">
        <strong>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong><br>
        {% if order.approved_by %}
          {{ order.approved_by.username }}
          {% if order.approved_at %}
            <br><small class="text-muted">{{ order.approved_at|date:"d/m/Y H:i" }}</small>
          {% endif %}
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </div>
      <div class="col-md-4">
        <strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong><br>
        <span class="text-primary fs-5 fw-bold" id="currentTotal">{{ order.total_cost|floatformat:2 }}</span> ‡∏ö‡∏≤‡∏ó
      </div>
    </div>
  </div>
</div>

<form method="post" id="orderEditForm">
  {% csrf_token %}
  
  <!-- Order Details Section -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-edit me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Delivery Round -->
        <div class="col-md-6 mb-3">
          <label for="delivery_round" class="form-label">
            <i class="fas fa-truck me-2"></i>‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
          </label>
          <select class="form-select" id="delivery_round" name="delivery_round">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á --</option>
            {% for round in delivery_rounds %}
              <option value="{{ round.id }}" 
                      {% if order.delivery_round and order.delivery_round.id == round.id %}selected{% endif %}>
                {{ round.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Approval Status (for admin/staff) -->
        {% if user.is_staff %}
        <div class="col-md-6 mb-3">
          <label for="approval_status" class="form-label">
            <i class="fas fa-check-circle me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </label>
          <select class="form-select" id="approval_status" name="approval_status">
            <option value="pending" {% if order.approval_status == 'pending' %}selected{% endif %}>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="approved" {% if order.approval_status == 'approved' %}selected{% endif %}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="rejected" {% if order.approval_status == 'rejected' %}selected{% endif %}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
          </select>
        </div>
        {% endif %}
        
        <!-- Note -->
        <div class="col-12 mb-3">
          <label for="note" class="form-label">
            <i class="fas fa-sticky-note me-2"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
          </label>
          <textarea id="note" name="note" class="form-control" rows="3" 
                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå...">{{ order.note }}</textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Material Items Section -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h5>
      <button type="button" class="btn btn-light btn-sm" onclick="addNewItem()">
        <i class="fas fa-plus me-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
    </div>
    <div class="card-body p-0">
      <!-- Search for new materials -->
      <div class="p-3 bg-light border-bottom">
        <div class="row">
          <div class="col-md-8">
            <input type="text" id="searchBox" class="form-control" 
                   placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà...">
          </div>
          <div class="col-md-4">
            <button type="button" class="btn btn-outline-success w-100" onclick="toggleSearchResults()">
              <i class="fas fa-search me-1"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
          </div>
        </div>
        <ul id="search-results" class="list-group mt-2" style="display: none;"></ul>
      </div>
      
      <!-- Materials Table -->
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0" id="materialsTable">
          <thead class="table-dark">
            <tr>
              <th width="5%">#</th>
              <th width="20%">‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
              <th width="10%">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th width="15%">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th width="10%">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th width="15%">‡∏£‡∏ß‡∏°</th>
              <th width="15%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th width="10%">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items.all %}
            <tr data-item-id="{{ item.id }}">
              <td>{{ forloop.counter }}</td>
              <td>
                <strong>{{ item.material.code }}</strong><br>
                <small class="text-muted">{{ item.material.name }}</small>
              </td>
              <td>{{ item.material.unit }}</td>
              <td>
                <input type="number" 
                       step="0.01" 
                       name="cost_{{ item.id }}" 
                       value="{{ item.unit_cost }}" 
                       class="form-control item-cost"
                       min="0"
                       onchange="updateItemTotal(this)" readonly>
              </td>
              <td>
                <input type="number" 
                       name="qty_{{ item.id }}" 
                       value="{{ item.quantity }}" 
                       class="form-control item-quantity"
                       min="1"
                       onchange="updateItemTotal(this)">
              </td>
              <td>
                <span class="fw-bold text-success item-total">{{ item.total_cost|floatformat:2 }}</span> ‡∏ö‡∏≤‡∏ó
              </td>
              <td>
                <input type="text" 
                       name="note_{{ item.id }}" 
                       value="{{ item.note|default:'' }}" 
                       class="form-control form-control-sm"
                       placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-sm" 
                        onclick="removeItem({{ item.id }})"
                        title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="5" class="text-end"><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong></td>
              <td><strong class="text-primary fs-5" id="grandTotal">{{ order.total_cost|floatformat:2 }}</strong> ‡∏ö‡∏≤‡∏ó</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Hidden fields for new items -->
  <div id="hiddenFields"></div>

  <!-- Action Buttons -->
  <div class="d-flex gap-2 justify-content-end">
    <a href="{% url 'home' %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </a>
    
    <button type="button" class="btn btn-warning" onclick="resetForm()">
      <i class="fas fa-undo me-1"></i>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    </button>
    
    <button type="submit" class="btn btn-success">
      <i class="fas fa-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    </button>
  </div>
</form>

<!-- Change Log (if needed) -->
<div class="card mt-4">
  <div class="card-header bg-secondary text-white">
    <h6 class="mb-0"><i class="fas fa-history me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ order.created_at|date:"d/m/Y H:i:s" }}</small>
      </div>
      <div class="col-md-6">
        <small class="text-muted">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {{ order.updated_at|date:"d/m/Y H:i:s" }}</small>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let removedItems = new Set();
let newItemCounter = 0;

// Update item total calculation
function updateItemTotal(input) {
  const row = input.closest('tr');
  const costInput = row.querySelector('.item-cost');
  const qtyInput = row.querySelector('.item-quantity');
  const totalSpan = row.querySelector('.item-total');
  
  const cost = parseFloat(costInput.value) || 0;
  const qty = parseInt(qtyInput.value) || 0;
  const total = cost * qty;
  
  totalSpan.textContent = total.toFixed(2);
  updateGrandTotal();
}

// Update grand total
function updateGrandTotal() {
  let grandTotal = 0;
  document.querySelectorAll('.item-total').forEach(span => {
    const value = parseFloat(span.textContent) || 0;
    grandTotal += value;
  });
  
  document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}

// Remove item
function removeItem(itemId) {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (row) {
      row.style.display = 'none';
      removedItems.add(itemId);
      
      // Add hidden field to track removed items
      const hiddenField = document.createElement('input');
      hiddenField.type = 'hidden';
      hiddenField.name = 'removed_items';
      hiddenField.value = itemId;
      document.getElementById('hiddenFields').appendChild(hiddenField);
      
      updateGrandTotal();
      updateRowNumbers();
    }
  }
}

// Update row numbers
function updateRowNumbers() {
  const visibleRows = document.querySelectorAll('#materialsTable tbody tr:not([style*="display: none"])');
  visibleRows.forEach((row, index) => {
    row.cells[0].textContent = index + 1;
  });
}

// Search materials
document.getElementById('searchBox').addEventListener('input', function() {
  const query = this.value;
  if (query.length < 2) {
    document.getElementById('search-results').style.display = 'none';
    return;
  }
  
  fetch(`/search/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      const searchResults = document.getElementById('search-results');
      searchResults.innerHTML = '';
      
      if (data.length === 0) {
        searchResults.innerHTML = '<li class="list-group-item">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';
      } else {
        data.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          li.style.cursor = 'pointer';
          li.innerHTML = `
            <div>
              <strong>${item.name}</strong> (${item.code})<br>
              <small class="text-muted">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${item.unit || '-'}</small>
            </div>
            <span class="badge bg-secondary">${item.cost} ‡∏ö‡∏≤‡∏ó</span>
          `;
          li.onclick = () => addMaterial(item);
          searchResults.appendChild(li);
        });
      }
      searchResults.style.display = 'block';
    })
    .catch(error => {
      console.error('Error:', error);
    });
});

// Toggle search results
function toggleSearchResults() {
  const searchResults = document.getElementById('search-results');
  searchResults.style.display = searchResults.style.display === 'none' ? 'block' : 'none';
}

// Add new material to order
function addMaterial(material) {
  newItemCounter++;
  const tbody = document.querySelector('#materialsTable tbody');
  const newRow = document.createElement('tr');
  newRow.setAttribute('data-new-item', newItemCounter);
  
  newRow.innerHTML = `
    <td>${tbody.children.length + 1}</td>
    <td>
      <strong>${material.code}</strong><br>
      <small class="text-muted">${material.name}</small>
      <input type="hidden" name="new_material_${newItemCounter}" value="${material.id}">
    </td>
    <td>${material.unit || '-'}</td>
    <td>
      <input type="number" 
             step="0.01" 
             name="new_cost_${newItemCounter}" 
             value="${material.cost}" 
             class="form-control item-cost"
             min="0"
             onchange="updateItemTotal(this)">
    </td>
    <td>
      <input type="number" 
             name="new_qty_${newItemCounter}" 
             value="1" 
             class="form-control item-quantity"
             min="1"
             onchange="updateItemTotal(this)">
    </td>
    <td>
      <span class="fw-bold text-success item-total">${material.cost}</span> ‡∏ö‡∏≤‡∏ó
    </td>
    <td>
      <input type="text" 
             name="new_note_${newItemCounter}" 
             class="form-control form-control-sm"
             placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
    </td>
    <td>
      <button type="button" class="btn btn-danger btn-sm" 
              onclick="removeNewItem(${newItemCounter})"
              title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  `;
  
  tbody.appendChild(newRow);
  updateGrandTotal();
  updateRowNumbers();
  
  // Clear search
  document.getElementById('searchBox').value = '';
  document.getElementById('search-results').style.display = 'none';
}

// Remove new item
function removeNewItem(counter) {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    const row = document.querySelector(`tr[data-new-item="${counter}"]`);
    if (row) {
      row.remove();
      updateGrandTotal();
      updateRowNumbers();
    }
  }
}

// Reset form
function resetForm() {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ')) {
    location.reload();
  }
}

// Form validation
document.getElementById('orderEditForm').addEventListener('submit', function(e) {
  const visibleRows = document.querySelectorAll('#materialsTable tbody tr:not([style*="display: none"])');
  if (visibleRows.length === 0) {
    e.preventDefault();
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }
  
  // Validate quantities and costs
  let hasError = false;
  visibleRows.forEach(row => {
    const qtyInput = row.querySelector('.item-quantity');
    const costInput = row.querySelector('.item-cost');
    
    if (!qtyInput.value || parseInt(qtyInput.value) < 1) {
      alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
      qtyInput.focus();
      hasError = true;
      return;
    }
    
    if (!costInput.value || parseFloat(costInput.value) < 0) {
      alert('‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0');
      costInput.focus();
      hasError = true;
      return;
    }
  });
  
  if (hasError) {
    e.preventDefault();
  }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  updateGrandTotal();
});
</script>
{% endblock %}